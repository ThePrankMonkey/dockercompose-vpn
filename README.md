# Docker VPN Settings

## Setup

1. Rename `.env.exmaple` to `.env`
2. Edit the variables as you see fit.

## Settings

1. Use the attached `docker-compose.yaml` to build things.
2. Set firewall to allow passthrough of port `51820/udp`.
3. Configure automatic updates to docker images.

## Containers

We have two needs for this, a secure tunnel and a dynamic dns updater.

### [ddclient](https://hub.docker.com/r/linuxserver/ddclient)

This can handle basically any ddns provider. I started with duckdns but got weird routing issues on things, no-ip works better.

Note, the `use=` key needs to be defined BEFORE the rest of the keys.

#### duckdns

**TEST FAILURE**

```ini
##
## Duckdns (http://www.duckdns.org/)
##
use=web					# via web

protocol=duckdns, \
password=<YOUR-TOKEN-HERE> \
<YOURDOMAIN> # eg domain, not domain.duckdns.org
```

#### no-ip

To be tested using these [instructions](https://coderwall.com/p/wux7ug/ddclient-no-ip).

**TEST SUCCESS**

```ini
##
## No-IP (http://my.noip.com/)
##
use=web, web=checkip.dyndns.com/, web-skip='IP Address'

protocol=dyndns2
server=dynupdate.no-ip.com
login=<YOURUSERNAME>
password=<YOURPASSWORD>
<YOURFQDN> # the ddns fqdn, eg. something.noip.org
```

## Wireguard

https://hub.docker.com/r/linuxserver/wireguard

Had to install a couple things and reboot. Follow the steps here for your OS: https://www.wireguard.com/install/

```bash
sudo yum install kmod-wireguard wireguard-tools
```

Also had to add portforwarding on my router as described above for `51820/UDP`.

After that, I can just change the number of clients to generate. I think I can provide a list of names as well.
It'll spit out some QR codes that I just need to scan to add to the [phone app](https://play.google.com/store/apps/details?id=com.wireguard.android&hl=en_US&gl=US). The QR codes are located in under the docker configs folder for this container, I've got them going under a folder called `wireguard`.

I also found this other container:

- https://old.reddit.com/r/selfhosted/comments/ug5vz8/setting_up_a_vpn_for_homelab/

## Pihole

Using this to block ads and sites from home network.

- https://hub.docker.com/r/pihole/pihole
- https://github.com/pi-hole/docker-pi-hole#readme
- https://discourse.pi-hole.net/t/the-pihole-command-with-examples/738

**NOTE**, you can get the `WEBPASSSWORD` that is randomly generated by using `docker logs pihole | grep random`

```bash
docker-compose exec pihole pihole updateGravity
```

## Issues

### Missing wireguard module

```
wireguard    | **** The wireguard module is not active. If you believe that your kernel should have wireguard support already, make sure that it is activated via modprobe! ****
wireguard    | ****  If you have an old kernel without wireguard support built-in, you can try using the legacy tag for this image to compile the modules from scratch.   ****
```

Need to install shit:

```bash
sudo yum install kmod-wireguard wireguard-tools
```

And make sure it's activated by rebooting host.

**NOTE**: I ran into an issue where the module and the kernal were out of date. I had to update the kernal to fix this because a power outage caused a reboot.

### Handshake Not Completing

I kept seeing this message in the client's log:

```
Handshake did not complete after 5 seconds, retrying
```

- Nothing was hitting the wireguard container.
- I verified that:
  - my credential file was good (generated a new one)
  - port was getting forwarded
  - DynamicDNS was updated to the right ip
  - other things hosted on the dynamic dns were working

I fixed it by restarting my Google Wifi network. I think it just stopped handling UDP connections for some reason.

This issue has been detected on the following days, though may have been present for longer:

- 2023.07.30
- 2023.08.20

Per [this reddit post](https://www.reddit.com/r/GoogleWiFi/comments/15g1eyn/fyi_i_fixed_my_udp_port_forwarding_issues_on_nest/), it may be related to UPnP being enabled. I've turned that off as well and we'll see if the problem comes back.

### Issue - PiHole - Error starting userland proxy: listen tcp4 0.0.0.0:53: bind: address already in use

```
ERROR: for pihole  Cannot start service pihole: driver failed programming external connectivity on endpoint pihole (67a7efa9987b16cfccef7b2194c6ed90c439fd5d603c02ff1da0e6042b64ed2e): Error starting userland proxy: listen tcp4 0.0.0.0:53: bind: address already in use
ERROR: Encountered errors while bringing up the project.
```

I checked `netstat` and `lsof`, but nothing looks to be bound to port 53. `sudo lsof -i :53` shows that it's dnsmasq. I killed it, but I need to figure out what started it since its not systemctl.

### Issue - PiHole - 403 Forbidden

If I try to hit the web ui, I get a 403 Forbidden message...

I had the wrong link... http://192.168.86.79:8053/admin, it needs that `/admin` part. Duh.

- https://discourse.pi-hole.net/t/403-forbidden-when-i-try-to-access-the-dashboard/65593
